<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Finder ‚Äì Prototyp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #eaeaea;
    }

    /* Handy-Rahmen */
    .phone {
      width: 360px;
      height: 720px;
      background: #fff;
      border-radius: 40px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
      overflow: hidden;
      position: relative;
    }

    /* Wenn ein Modal offen ist: Background nicht klickbar */
    .phone.modal-open .card-area,
    .phone.modal-open .actions,
    .phone.modal-open .header {
      pointer-events: none;
    }

    .phone.modal-open .overlay,
    .phone.modal-open .likes-view,
    .phone.modal-open .chats-view,
    .phone.modal-open .chat-thread-view {
      pointer-events: auto;
    }

    .header {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid #eee;
      user-select: none;
      -webkit-user-select: none;
    }

    .header h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.2px;
    }

    .menu-btn {
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Kartenbereich */
    .card-area {
      position: relative;
      height: calc(100% - 200px);
      padding: 16px;
    }

    .card {
      z-index: 1;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;

      position: absolute;
      width: calc(100% - 32px);
      height: 100%;
      border-radius: 20px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: flex-end;
      padding: 16px;
      transition: transform 0.28s ease, opacity 0.28s ease;
      touch-action: none;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.62), transparent 60%);
    }

    .card-content {
      position: relative;
      color: #fff;
      z-index: 1;
    }

    .card-content h2 {
      margin: 0;
      font-size: 22px;
    }

    .card-content p {
      margin: 6px 0 0;
      font-size: 14px;
      opacity: 0.95;
    }

    /* Buttons */
    .actions {
      height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 10px;
      border-top: 1px solid #f0f0f0;
      padding: 10px 0;
      user-select: none;
      -webkit-user-select: none;
    }

    .primary-actions {
      display: flex;
      gap: 18px;
      justify-content: center;
      align-items: center;
    }

    .action-btn {
      border: none;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .round {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
    }

    .pill {
      width: 220px;
      height: 40px;
      border-radius: 999px;
      font-size: 14px;
      padding: 0 14px;
    }

    .dislike { background: #ffdddd; }
    .like { background: #ddffef; }
    .info { background: #dde7ff; font-size: 20px; }
    .book { background: #dde7ff; }
    .reset { background: #f0f0f0; }

    /* Bottom-sheet overlay (Detail) */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: flex-end;
      z-index: 50;
    }

    .sheet {
      background: #fff;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 20px;
      max-height: 84%;
      overflow: auto;
      position: relative;
      z-index: 51;
    }

    .sheet h2 { margin-top: 0; }

    .back-btn {
      margin-bottom: 12px;
      cursor: pointer;
      color: #007bff;
      user-select: none;
      -webkit-user-select: none;
    }

    .empty {
      padding: 14px;
      border: 1px dashed #ddd;
      border-radius: 12px;
      color: #666;
      background: #fff;
    }

    /* Likes */
    .likes-view {
      z-index: 60;
      position: absolute;
      inset: 0;
      background: #fff;
      padding: 16px;
      display: none;
      flex-direction: column;
    }

    .likes-view h2 { margin-top: 0; }

    .likes-view ul {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow: auto;
      max-height: calc(100% - 60px);
    }

    .likes-view li {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .likes-view li span {
      opacity: 0.75;
      font-size: 12px;
      white-space: nowrap;
    }

    /* Chats list (WhatsApp-like) */
    .chats-view {
      z-index: 60;
      position: absolute;
      inset: 0;
      background: #fff;
      padding: 16px;
      display: none;
      flex-direction: column;
    }

    .chats-view h2 { margin-top: 0; }

    .chat-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow: auto;
      max-height: calc(100% - 60px);
    }

    .chat-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #f2f2f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #444;
      flex: 0 0 auto;
    }

    .chat-meta {
      flex: 1;
      min-width: 0;
    }

    .chat-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: baseline;
    }

    .chat-title {
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      font-size: 12px;
      opacity: 0.6;
      white-space: nowrap;
    }

    .chat-last {
      font-size: 13px;
      opacity: 0.75;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 3px;
    }

    /* Chat thread */
    .chat-thread-view {
      z-index: 65;
      position: absolute;
      inset: 0;
      background: #fff;
      display: none;
      flex-direction: column;
    }

    .chat-thread-header {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      border-bottom: 1px solid #eee;
      user-select: none;
      -webkit-user-select: none;
    }

    .chat-thread-title {
      font-weight: 900;
      font-size: 16px;
      flex: 1;
      margin: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    .chat-thread-body {
      flex: 1;
      padding: 14px;
      overflow: auto;
      background: #fafafa;
    }

        .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin: 8px 0;
    }

    .msg-row.me {
      justify-content: flex-end;
    }

    .msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 12px;
      color: #444;
      flex: 0 0 auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .msg-bubble {
      max-width: 72%;
      padding: 8px 10px;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      font-size: 13px;
      line-height: 1.25;
      white-space: pre-wrap;
      word-break: break-word;
      background: #fff;
    }

    .msg-row.me .msg-bubble {
      background: #dde7ff;
      border-top-right-radius: 6px;
    }

    .msg-row.them .msg-bubble {
      border-top-left-radius: 6px;
    }

    .msg-name {
      font-size: 11px;
      font-weight: 800;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .msg-meta {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 6px;
    }

    .chat-thread-input {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .chat-thread-input input {
      flex: 1;
      height: 40px;
      border-radius: 999px;
      border: 1px solid #e6e6e6;
      padding: 0 14px;
      font-size: 14px;
      outline: none;
    }

    .chat-thread-input button {
      height: 40px;
      border-radius: 999px;
      border: none;
      padding: 0 16px;
      cursor: pointer;
      background: #ddffef;
      font-weight: 800;
      box-shadow: 0 5px 15px rgba(0,0,0,0.14);
    }
  </style>
</head>
<body>

<div class="phone">
  <div class="header">
    <span class="menu-btn" onclick="openLikes()" title="Likes anzeigen">‚≠ê</span>
    <h1>Finder</h1>
    <span class="menu-btn" onclick="openChats()" title="Chats">üí¨</span>
  </div>

  <div class="card-area" id="cardArea"></div>

  <div class="actions">
    <div class="primary-actions">
      <button class="action-btn round dislike" onclick="swipe('left')" title="Dislike">‚ùå</button>
      <button class="action-btn round info" onclick="openDetails()" title="Mehr Infos">‚ÑπÔ∏è</button>
      <button class="action-btn round like" onclick="swipe('right')" title="Like">‚ù§Ô∏è</button>
    </div>

    <button class="action-btn pill reset" onclick="resetApp()" title="Debug Reset">üõ† Debug: Reset</button>
  </div>

  <!-- Detail Overlay -->
  <div class="overlay" id="detailView">
    <div class="sheet">
      <div class="back-btn" onclick="closeDetails()">‚Üê Schlie√üen</div>
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- Likes -->
  <div class="likes-view" id="likesView">
    <div class="back-btn" onclick="closeLikes()">‚Üê Zur√ºck</div>
    <h2>Deine Likes</h2>
    <ul id="likesList"></ul>
  </div>

  <!-- Chats List -->
  <div class="chats-view" id="chatsView">
    <div class="back-btn" onclick="closeChats()">‚Üê Zur√ºck</div>
    <h2>Chats</h2>
    <ul class="chat-list" id="chatList"></ul>
  </div>

  <!-- Chat Thread -->
  <div class="chat-thread-view" id="chatThreadView">
    <div class="chat-thread-header">
      <span class="menu-btn" onclick="backToChatList()">‚Üê</span>
      <div class="chat-thread-title" id="chatThreadTitle">Chat</div>
      <span class="menu-btn" onclick="closeChatThread()">‚úï</span>
    </div>
    <div class="chat-thread-body" id="chatThreadBody"></div>
    <div class="chat-thread-input">
      <input id="chatInput" type="text" placeholder="Nachricht schreiben‚Ä¶" />
      <button onclick="sendMessage()">Senden</button>
    </div>
  </div>
</div>

<script>
  const events = [
    { id: "jazz", title: "Jazz Konzert", location: "Bochum", image: "https://images.unsplash.com/photo-1511379938547-c1f69419868d?auto=format&fit=crop&w=1200&q=60", date: "01.01.2026", time: "19:00", description: "Live-Jazz mit lokalen Musiker:innen. Cozy, intim, kein Dresscode." },
    { id: "theater", title: "Theater Premiere", location: "Essen", image: "https://images.unsplash.com/photo-1503095396549-807759245b35?auto=format&fit=crop&w=1200&q=60", date: "05.01.2026", time: "20:00", description: "Premiere eines zeitgen√∂ssischen St√ºcks. Diskussion nach der Auff√ºhrung." },
    { id: "kunst", title: "Kunstausstellung", location: "Dortmund", image: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60", date: "08.01.2026", time: "17:30", description: "Mixed Media Ausstellung. Vernissage mit kurzer Einf√ºhrung." },
    { id: "slam", title: "Poetry Slam Night", location: "K√∂ln", image: "https://images.unsplash.com/photo-1515169067865-5387ec356754?auto=format&fit=crop&w=1200&q=60", date: "12.01.2026", time: "19:30", description: "Slammer:innen aus der Region. Publikumsvoting am Ende." },
    { id: "film", title: "Indie Film Screening", location: "D√ºsseldorf", image: "https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&w=1200&q=60", date: "15.01.2026", time: "21:00", description: "Indie-Film + Q&A. Englisch mit deutschen Untertiteln." },
    { id: "street", title: "Stra√üentheater Festival", location: "M√ºnster", image: "https://images.unsplash.com/photo-1508609349937-5ec4ae374ebf?auto=format&fit=crop&w=1200&q=60", date: "20.01.2026", time: "16:00", description: "Open-Air Acts in der Innenstadt. Kostenlos, Hutspende willkommen." },
    { id: "sound", title: "Elektronische Klangkunst", location: "Berlin", image: "https://images.unsplash.com/photo-1507874457470-272b3c8d8ee2?auto=format&fit=crop&w=1200&q=60", date: "24.01.2026", time: "22:00", description: "Audiovisuelle Performance. Limitierte Pl√§tze." },
    { id: "lesung", title: "Lesung im Literaturhaus", location: "Hamburg", image: "https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&w=1200&q=60", date: "28.01.2026", time: "18:30", description: "Autor:innengespr√§ch + Signierstunde." },
    { id: "impro", title: "Open Air Impro", location: "Bonn", image: "https://images.unsplash.com/photo-1520975682038-6f2a6a8b2f6e?auto=format&fit=crop&w=1200&q=60", date: "02.02.2026", time: "19:00", description: "Improshow unter freiem Himmel. Wetterfeste Kleidung empfohlen." }
  ];

  let currentIndex = 0;
  const likes = [];

  const cardArea = document.getElementById('cardArea');
  const phoneEl = document.querySelector('.phone');

  // chats[eventId] = {
  //   eventId,
  //   title,
  //   participants: [{ id, name }],
  //   messages: [{ senderId, text, ts }]
  // }
  const chats = {};
  let activeChatId = null;

  function updateModalOpen() {
    const detailOpen = document.getElementById('detailView').style.display === 'flex';
    const likesOpen = document.getElementById('likesView').style.display === 'flex';
    const chatsOpen = document.getElementById('chatsView').style.display === 'flex';
    const threadOpen = document.getElementById('chatThreadView').style.display === 'flex';
    phoneEl.classList.toggle('modal-open', detailOpen || likesOpen || chatsOpen || threadOpen);
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function nowTime() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  function getCurrentEvent() {
    return currentIndex >= 0 && currentIndex < events.length ? events[currentIndex] : null;
  }

  function initials(title) {
    const words = String(title)
      .trim()
      .split(' ')
      .filter(Boolean)
      .slice(0, 2);
    return words.map(w => (w[0] ? w[0].toUpperCase() : '')).join('');
  }

  function ensureChatForEvent(ev) {
    if (!ev) return;
    if (chats[ev.id]) return;

    // Fake Teilnehmer:innen (Gruppenchat)
    const roster = [
      { id: 'me', name: 'Du' },
      { id: 'mira', name: 'Mira' },
      { id: 'alex', name: 'Alex' },
      { id: 'sam', name: 'Sam' }
    ];

    const t = nowTime();
    const fake = [
      { senderId: 'mira', text: `Hat noch jemand Bock auf ‚Äû${ev.title}‚Äú? üòä`, ts: t },
      { senderId: 'alex', text: 'Yes! Ich hab‚Äôs auch geliked. Wollen wir zusammen hin?', ts: t },
      { senderId: 'me', text: 'Ich w√§re dabei üôå Wei√ü jemand wie fr√ºh man da sein sollte?', ts: t },
      { senderId: 'sam', text: 'Kommt auf den Andrang an ‚Äì ich w√ºrde 20‚Äì30 Min fr√ºher da sein.', ts: t }
    ];

    chats[ev.id] = {
      eventId: ev.id,
      title: ev.title,
      participants: roster,
      messages: fake
    };
  }

  function renderCard() {
    cardArea.innerHTML = '';

    if (currentIndex >= events.length) {
      const done = document.createElement('div');
      done.className = 'empty';
      done.innerHTML = `
        <div style="font-weight:800; margin-bottom:6px">Keine weiteren Events üé≠</div>
        <div style="margin-bottom:10px">Du kannst oben ‚≠ê deine Likes ansehen oder üí¨ deine Chats √∂ffnen.</div>
        <button class="action-btn pill reset" onclick="resetApp()">Neu starten</button>
      `;
      cardArea.appendChild(done);
      return;
    }

    const event = events[currentIndex];
    const card = document.createElement('div');
    card.className = 'card';
    card.style.backgroundImage = `url(${event.image})`;

    card.innerHTML = `
      <div class="card-content">
        <h2>${escapeHtml(event.title)}</h2>
        <p>üìç ${escapeHtml(event.location)} ‚Ä¢ ${escapeHtml(event.date)} ‚Ä¢ ${escapeHtml(event.time)}</p>
      </div>
    `;

    cardArea.appendChild(card);
  }

  function swipe(direction) {
    const card = document.querySelector('.card');
    if (!card) return;
    if (currentIndex >= events.length) return;

    const ev = events[currentIndex];

    if (direction === 'right') {
      likes.push(ev);
      ensureChatForEvent(ev);
    }

    card.style.transform = direction === 'right'
      ? 'translateX(420px) rotate(18deg)'
      : 'translateX(-420px) rotate(-18deg)';

    card.style.opacity = '0';

    window.setTimeout(() => {
      currentIndex++;
      renderCard();
    }, 280);
  }

  function openDetails() {
    const event = getCurrentEvent();
    if (!event) return;

    const content = document.getElementById('detailContent');
    content.innerHTML = `
      <h2>${escapeHtml(event.title)}</h2>
      <p><strong>Ort:</strong> ${escapeHtml(event.location)}</p>
      <p><strong>Datum:</strong> ${escapeHtml(event.date)}</p>
      <p><strong>Uhrzeit:</strong> ${escapeHtml(event.time)}</p>
      <p style="margin-top:12px"><strong>Info:</strong> ${escapeHtml(event.description || '‚Äî')}</p>
      <p style="margin-top:12px">Dies ist eine <em>Dummy-Detailansicht</em>. Sp√§ter k√∂nnen hier Tickets, K√ºnstler:innen, Preise oder Maps integriert werden.</p>
      <button class="action-btn pill book" style="margin-top:16px" onclick="bookEvent()">üìÖ Termin buchen</button>
    `;

    document.getElementById('detailView').style.display = 'flex';
    updateModalOpen();
  }

  function closeDetails(silent = false) {
    document.getElementById('detailView').style.display = 'none';
    updateModalOpen();
    if (!silent) console.info('Details closed');
  }

  function bookEvent() {
    const event = getCurrentEvent();
    if (!event) return;

    alert(`üìÖ Dummy-Buchung

Event: ${event.title}
Ort: ${event.location}
Datum: ${event.date}
Uhrzeit: ${event.time}

Status: (noch nicht implementiert)`);
  }

  function resetApp() {
    currentIndex = 0;
    likes.length = 0;

    for (const k of Object.keys(chats)) delete chats[k];
    activeChatId = null;

    closeLikes(true);
    closeDetails(true);
    closeChats(true);
    closeChatThread(true);

    updateModalOpen();
    renderCard();
    console.clear();
    console.info('Reset done');
  }

  // ===== Likes =====
  function openLikes() {
    const view = document.getElementById('likesView');
    view.style.display = 'flex';
    updateModalOpen();

    const list = document.getElementById('likesList');
    list.innerHTML = '';

    if (likes.length === 0) {
      const li = document.createElement('li');
      li.innerHTML = '<div>Keine Likes bisher</div><span>‚Äî</span>';
      list.appendChild(li);
      return;
    }

    likes.forEach((e, idx) => {
      const li = document.createElement('li');
      li.innerHTML = `<div>${escapeHtml(e.title)} ‚Äì ${escapeHtml(e.location)}</div><span>#${idx + 1}</span>`;
      list.appendChild(li);
    });
  }

  function closeLikes(silent = false) {
    document.getElementById('likesView').style.display = 'none';
    updateModalOpen();
    if (!silent) console.info('Likes closed');
  }

  // ===== Chats =====
  function openChats() {
    const view = document.getElementById('chatsView');
    view.style.display = 'flex';
    updateModalOpen();
    renderChatList();
  }

  function closeChats(silent = false) {
    document.getElementById('chatsView').style.display = 'none';
    updateModalOpen();
    if (!silent) console.info('Chats closed');
  }

  function renderChatList() {
    const ul = document.getElementById('chatList');
    ul.innerHTML = '';

    const unique = Array.from(new Set(likes.map(e => e.id)));

    if (unique.length === 0) {
      const li = document.createElement('li');
      li.className = 'empty';
      li.style.listStyle = 'none';
      li.textContent = 'Noch keine Chats. Like ein Event (‚ù§Ô∏è), dann erscheint hier eine Gruppe.';
      ul.appendChild(li);
      return;
    }

    unique.slice().reverse().forEach(eventId => {
      const chat = chats[eventId];
      if (!chat) return;
      const last = chat.messages[chat.messages.length - 1];

      const li = document.createElement('li');
      li.className = 'chat-item';
      li.onclick = () => openChatThread(eventId);

      li.innerHTML = `
        <div class="avatar">${escapeHtml(initials(chat.title))}</div>
        <div class="chat-meta">
          <div class="chat-top">
            <div class="chat-title">${escapeHtml(chat.title)}</div>
            <div class="chat-time">${escapeHtml(last?.ts || '')}</div>
          </div>
          <div class="chat-last">${escapeHtml(last?.text || '')}</div>
        </div>
      `;

      ul.appendChild(li);
    });
  }

  function openChatThread(eventId) {
    activeChatId = eventId;
    const view = document.getElementById('chatThreadView');
    view.style.display = 'flex';
    updateModalOpen();

    const chat = chats[eventId];
    document.getElementById('chatThreadTitle').textContent = chat ? chat.title : 'Chat';

    renderChatThread();

    const input = document.getElementById('chatInput');
    input.value = '';
    input.focus();
  }

  function backToChatList() {
    closeChatThread(true);
    openChats();
  }

  function closeChatThread(silent = false) {
    document.getElementById('chatThreadView').style.display = 'none';
    updateModalOpen();
    if (!silent) console.info('Thread closed');
  }

  function renderChatThread() {
    const body = document.getElementById('chatThreadBody');
    body.innerHTML = '';

    const chat = chats[activeChatId];
    if (!chat) {
      const div = document.createElement('div');
      div.className = 'empty';
      div.textContent = 'Chat nicht gefunden.';
      body.appendChild(div);
      return;
    }

    const participants = chat.participants || [];
    const nameById = Object.fromEntries(participants.map(p => [p.id, p.name]));

    chat.messages.forEach(m => {
      const isMe = m.senderId === 'me';
      const row = document.createElement('div');
      row.className = `msg-row ${isMe ? 'me' : 'them'}`;

      const avatar = document.createElement('div');
      avatar.className = 'msg-avatar';

      const displayName = nameById[m.senderId] || (isMe ? 'Du' : 'Person');
      avatar.textContent = String(displayName)
        .trim()
        .split(' ')
        .filter(Boolean)
        .slice(0, 2)
        .map(w => (w[0] ? w[0].toUpperCase() : ''))
        .join('');

      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble';

      const nameLine = !isMe
        ? `<div class="msg-name">${escapeHtml(displayName)}</div>`
        : '';

      bubble.innerHTML = `
        ${nameLine}
        <div>${escapeHtml(m.text)}</div>
        <div class="msg-meta">${escapeHtml(m.ts || '')}</div>
      `;

      // Avatar neben der Bubble (Gruppenchat-Feeling)
      if (isMe) {
        row.appendChild(bubble);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(bubble);
      }

      body.appendChild(row);
    });

    body.scrollTop = body.scrollHeight;
  }

  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    const chat = chats[activeChatId];
    if (!chat) return;

    chat.messages.push({ senderId: 'me', text, ts: nowTime() });

    // Dummy Auto-Reply von einer random Person (nicht "Orga")
    const others = (chat.participants || []).filter(p => p.id !== 'me');
    const pick = others[Math.floor(Math.random() * others.length)] || { id: 'mira', name: 'Mira' };

    window.setTimeout(() => {
      const replies = [
        'Nice! üëç',
        'Ich freu mich schon üòÑ',
        'Wollen wir vorher kurz treffen?',
        'Ich check mal die Uhrzeit und sag gleich Bescheid.'
      ];
      chat.messages.push({ senderId: pick.id, text: replies[Math.floor(Math.random() * replies.length)], ts: nowTime() });
      renderChatThread();
      renderChatList();
    }, 450);

    input.value = '';
    renderChatThread();
    renderChatList();
  }

  // Enter = senden (nur wenn Thread offen)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && document.getElementById('chatThreadView').style.display === 'flex') {
      sendMessage();
    }
  });

  // ===== Mini-Tests =====
  function runTests() {
    console.group('Finder tests');

    console.assert(Array.isArray(events), 'events should be an array');
    console.assert(events.length >= 6, 'should have at least 6 dummy events');

    // Like creates chat
    currentIndex = 0;
    swipe('right');
    console.assert(likes.length === 1, 'liking should add to likes');
    console.assert(Object.keys(chats).length === 1, 'liking should create a chat group');

    // Chats list shows item
    openChats();
    const items = document.querySelectorAll('#chatList .chat-item');
    console.assert(items.length >= 1, 'chat list should show a group');

    // Thread shows messages
    openChatThread(likes[0].id);
    const bubbles = document.querySelectorAll('#chatThreadBody .msg-bubble');
    console.assert(bubbles.length >= 3, 'thread should show fake messages');

    // Avatare sollten sichtbar sein
    const avatars = document.querySelectorAll('#chatThreadBody .msg-avatar');
    console.assert(avatars.length >= 3, 'thread should show avatars for messages');

    // Cleanup
    resetApp();

    console.groupEnd();
  }

  renderCard();
  runTests();
</script>

</body>
</html>
